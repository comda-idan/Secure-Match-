<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Secure Match Pro</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Secure Match">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Secure Match">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192x192/00f2fe/ffffff?text=SM">

    <link rel="manifest" href='data:application/json,{"name":"Secure Match Pro","short_name":"SecureMatch","start_url":"index.html","display":"standalone","orientation":"any","background_color":"#0f172a","theme_color":"#00f2fe","icons":[{"src":"https://via.placeholder.com/192x192/00f2fe/ffffff?text=SM","sizes":"192x192","type":"image/png"},{"src":"https://via.placeholder.com/512x512/00f2fe/ffffff?text=SM","sizes":"512x512","type":"image/png"}]}'>

    <style>
        :root {
            --primary: #00f2fe;
            --secondary: #4facfe;
            --danger: #ff4b2b;
            --success: #2ecc71;
            --glass: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.12);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.5rem;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }

        .logo-container { display: flex; align-items: center; gap: 12px; }
        #app-logo { height: 40px; width: auto; border-radius: 6px; }
        .app-title { font-size: 1.4rem; font-weight: 800; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        nav { display: flex; justify-content: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.2); }
        .nav-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .nav-btn.active { background: var(--secondary); box-shadow: 0 0 12px var(--secondary); border-color: transparent; }

        .tab-content { flex: 1; display: none; padding: 20px; overflow-y: auto; }
        #view-main.active { display: flex; gap: 20px; flex-direction: column; }

        @media (orientation: landscape) {
            #view-main.active { flex-direction: row; align-items: stretch; }
            .panel { min-height: unset !important; height: auto; padding: 15px !important; }
            #video-container, .user-image { max-width: 150px !important; }
        }

        .panel {
            flex: 1;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 350px;
        }

        #video-container {
            width: 100%;
            max-width: 280px;
            aspect-ratio: 1;
            background: #000;
            border-radius: 50%;
            border: 3px solid var(--secondary);
            position: relative;
            overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .scan-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 3px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            display: none;
        }
        .scanning .scan-line { display: block; animation: scanAnim 2s infinite ease-in-out; }
        @keyframes scanAnim { 0%, 100% { top: 10%; } 50% { top: 90%; } }

        .result-card { display: none; width: 100%; text-align: center; }
        .user-image { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px; }
        .info-list { width: 100%; text-align: right; margin-bottom: 15px; }
        .info-row { padding: 8px 0; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; font-size: 0.9rem; }
        .label { color: var(--secondary); font-weight: 600; }

        .table-container { overflow-x: auto; background: var(--glass); border-radius: 18px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid var(--glass-border); font-size: 0.85rem; }

        .btn-main { width: 100%; max-width: 240px; padding: 14px; border-radius: 50px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-scan { background: linear-gradient(45deg, var(--secondary), var(--primary)); color: white; }
        .btn-confirm { background: var(--success); color: white; }
        .fail-ui { background: rgba(255, 75, 43, 0.1) !important; border-color: var(--danger) !important; }

        .admin-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 30px; display: flex; opacity: 0; z-index: 1000; }
        .admin-box { flex: 1; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo-container">
        <img id="app-logo" src="logo.png" alt="Logo" onerror="this.src='https://via.placeholder.com/45?text=SM'">
        <span class="app-title">SECURE MATCH</span>
    </div>
    <nav>
        <button class="nav-btn active" id="btn-nav-main" onclick="switchTab('main')">זיהוי פנים</button>
        <button class="nav-btn" id="btn-nav-reports" onclick="switchTab('reports')">דוחות</button>
    </nav>
</header>

<main id="view-main" class="tab-content active">
    <section class="panel" id="scanner-panel">
        <h3 style="margin:0; color: var(--primary);">עמדת סריקה</h3>
        <div id="video-container">
            <video id="webcam" autoplay muted playsinline></video>
            <div class="scan-line"></div>
        </div>
        <button class="btn-main btn-scan" id="btn-start" onclick="runScan()" style="margin-top:15px">התחל סריקת פנים</button>
    </section>

    <section class="panel" id="result-panel">
        <h3 style="margin:0; color: var(--primary);">נתוני אימות</h3>
        <div id="idle-msg" style="opacity:0.4; text-align:center;"><p>ממתין לסריקה...</p></div>

        <div class="result-card" id="card-success">
            <img src="person.jpg" id="user-img-preview" class="user-image" onerror="this.src='https://via.placeholder.com/120'">
            <div class="info-list">
                <div class="info-row"><span class="label">שם:</span><span>ישראל ישראלי</span></div>
                <div class="info-row"><span class="label">ת.ז:</span><span>111111118</span></div>
                <div class="info-row"><span class="label">זמן:</span><span id="time-display"></span></div>
            </div>
            <button class="btn-main btn-confirm" onclick="approveAndSave()">אשר רישום</button>
        </div>

        <div class="result-card" id="card-fail">
            <div style="font-size: 3rem; color: var(--danger);">✕</div>
            <h3 style="color: var(--danger);">אין התאמה!</h3>
            <button class="nav-btn" onclick="resetUI()">חדש</button>
        </div>
    </section>
</main>

<section id="view-reports" class="tab-content">
    <h2 style="text-align: center; color: var(--secondary);">יומן רישומים</h2>
    <div class="table-container">
        <table>
            <thead><tr><th>שם מלא</th><th>תעודת זהות</th><th>מספר אסיר</th><th>זמן</th></tr></thead>
            <tbody id="reports-list">
                <tr><td>אברהם לוי</td><td>021445588</td><td>88542</td><td>08/02/2026 08:15</td></tr>
            </tbody>
        </table>
    </div>
</section>

<div class="admin-bar">
    <div class="admin-box" onclick="document.getElementById('file-logo').click()"></div>
    <div class="admin-box" onclick="toggleResultMode()"></div>
    <div class="admin-box" onclick="document.getElementById('file-user').click()"></div>
</div>

<input type="file" id="file-logo" hidden accept="image/*" onchange="uploadFile(this, 'app-logo', 'pref_logo')">
<input type="file" id="file-user" hidden accept="image/*" onchange="uploadFile(this, 'user-img-preview', 'pref_user')">

<script>
    // --- Service Worker Logic ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsgZXZlbnQucmVzcG9uZFdpdGgoZmV0Y2goZXZlbnQucmVxdWVzdCkpOyB9KTs=')
        .catch(() => {}); 
    }

    let successMode = true;
    let camStream = null;

    window.onload = () => {
        if(localStorage.getItem('pref_logo')) document.getElementById('app-logo').src = localStorage.getItem('pref_logo');
        if(localStorage.getItem('pref_user')) document.getElementById('user-img-preview').src = localStorage.getItem('pref_user');
    };

    function switchTab(target) {
        document.getElementById('view-main').classList.toggle('active', target === 'main');
        document.getElementById('view-reports').classList.toggle('active', target === 'reports');
        document.getElementById('btn-nav-main').classList.toggle('active', target === 'main');
        document.getElementById('btn-nav-reports').classList.toggle('active', target === 'reports');
        if(target !== 'main') stopCamera();
    }

    async function runScan() {
        try {
            camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('webcam').srcObject = camStream;
            document.getElementById('scanner-panel').classList.add('scanning');
            document.getElementById('btn-start').disabled = true;
            setTimeout(finishScan, 3000);
        } catch(e) { alert("נדרשת מצלמה ו-HTTPS"); }
    }

    function finishScan() {
        stopCamera();
        document.getElementById('scanner-panel').classList.remove('scanning');
        document.getElementById('idle-msg').style.display = 'none';
        if(successMode) {
            document.getElementById('time-display').innerText = new Date().toLocaleTimeString('he-IL');
            document.getElementById('card-success').style.display = 'block';
        } else {
            document.getElementById('card-fail').style.display = 'block';
            document.getElementById('result-panel').classList.add('fail-ui');
        }
    }

    function approveAndSave() {
        const row = `<tr><td>ישראל ישראלי</td><td>111111118</td><td>123456</td><td>${new Date().toLocaleString('he-IL')}</td></tr>`;
        document.getElementById('reports-list').innerHTML = row + document.getElementById('reports-list').innerHTML;
        alert("נרשם!");
        resetUI();
    }

    function resetUI() {
        document.getElementById('card-success').style.display = 'none';
        document.getElementById('card-fail').style.display = 'none';
        document.getElementById('idle-msg').style.display = 'block';
        document.getElementById('result-panel').classList.remove('fail-ui');
        document.getElementById('btn-start').disabled = false;
        document.getElementById('webcam').srcObject = null;
    }

    function stopCamera() { if(camStream) camStream.getTracks().forEach(t => t.stop()); }
    function toggleResultMode() { successMode = !successMode; alert("מצב: " + (successMode ? "הצלחה" : "כישלון")); }
    function uploadFile(i, id, k) {
        if (i.files && i.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { document.getElementById(id).src = e.target.result; localStorage.setItem(k, e.target.result); };
            r.readAsDataURL(i.files[0]);
        }
    }
</script>
</body>
</html>
